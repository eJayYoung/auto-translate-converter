{"version":3,"sources":["../../../lib/csv/csv.js"],"names":["fs","require","csv","moment","PromishLib","utils","CSV","module","exports","workbook","worksheet","SpecialValues","error","prototype","readFile","filename","options","self","stream","exists","then","Error","createReadStream","read","close","Promish","resolve","reject","csvStream","createInputStream","on","pipe","addWorksheet","sheetName","dateFormats","ISO_8601","map","datum","isNaN","parseFloat","dt","isValid","Date","valueOf","special","undefined","data","addRow","emit","write","getWorksheet","sheetId","createWriteStream","dateFormat","value","text","hyperlink","formula","result","format","JSON","stringify","includeEmptyRows","lastRow","eachRow","row","rowNumber","values","shift","end","writeFile","streamOptions","encoding"],"mappings":"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","file":"csv.js","sourcesContent":["/**\r\n * Copyright (c) 2015-2017 Guyon Roche\r\n * LICENCE: MIT - please refer to LICENCE file included with this module\r\n * or https://github.com/guyonroche/exceljs/blob/master/LICENSE\r\n */\r\n\r\n'use strict';\r\n\r\n\r\nvar fs = require('fs');\r\nvar csv = require('fast-csv');\r\nvar moment = require('moment');\r\nvar PromishLib = require('../utils/promish');\r\n\r\nvar utils = require('../utils/utils');\r\n\r\nvar CSV = module.exports = function(workbook) {\r\n  this.workbook = workbook;\r\n  this.worksheet = null;\r\n};\r\n\r\n/* eslint-disable quote-props */\r\nvar SpecialValues = {\r\n  'true': true,\r\n  'false': false,\r\n  '#N/A': { error: '#N/A' },\r\n  '#REF!': { error: '#REF!' },\r\n  '#NAME?': { error: '#NAME?' },\r\n  '#DIV/0!': { error: '#DIV/0!' },\r\n  '#NULL!': { error: '#NULL!' },\r\n  '#VALUE!': { error: '#VALUE!' },\r\n  '#NUM!': { error: '#NUM!' },\r\n};\r\n/* eslint-ensable quote-props */\r\n\r\n\r\nCSV.prototype = {\r\n  readFile: function(filename, options) {\r\n    var self = this;\r\n    options = options || {};\r\n    var stream;\r\n    return utils.fs.exists(filename)\r\n      .then(function(exists) {\r\n        if (!exists) {\r\n          throw new Error('File not found: ' + filename);\r\n        }\r\n        stream = fs.createReadStream(filename);\r\n        return self.read(stream, options);\r\n      })\r\n      .then(function(worksheet) {\r\n        stream.close();\r\n        return worksheet;\r\n      });\r\n  },\r\n  read: function(stream, options) {\r\n    options = options || {};\r\n    return new PromishLib.Promish((resolve, reject) => {\r\n      var csvStream = this.createInputStream(options)\r\n        .on('worksheet', resolve)\r\n        .on('error', reject);\r\n\r\n      stream.pipe(csvStream);\r\n    });\r\n  },\r\n  createInputStream: function(options) {\r\n    options = options || {};\r\n    var worksheet = this.workbook.addWorksheet(options.sheetName);\r\n\r\n    var dateFormats = options.dateFormats || [\r\n        moment.ISO_8601,\r\n        'MM-DD-YYYY',\r\n        'YYYY-MM-DD'\r\n      ];\r\n    var map = options.map || function(datum) {\r\n        if (datum === '') {\r\n          return null;\r\n        }\r\n        if (!isNaN(datum)) {\r\n          return parseFloat(datum);\r\n        }\r\n        var dt = moment(datum, dateFormats, true);\r\n        if (dt.isValid()) {\r\n          return new Date(dt.valueOf());\r\n        }\r\n        var special = SpecialValues[datum];\r\n        if (special !== undefined) {\r\n          return special;\r\n        }\r\n        return datum;\r\n      };\r\n\r\n    var csvStream = csv(options)\r\n      .on('data', function(data) {\r\n        worksheet.addRow(data.map(map));\r\n      })\r\n      .on('end', function() {\r\n        csvStream.emit('worksheet', worksheet);\r\n      });\r\n    return csvStream;\r\n  },\r\n\r\n  write: function(stream, options) {\r\n    return new PromishLib.Promish((resolve, reject) => {\r\n      options = options || {};\r\n      // var encoding = options.encoding || 'utf8';\r\n      // var separator = options.separator || ',';\r\n      // var quoteChar = options.quoteChar || '\\'';\r\n\r\n      var worksheet = this.workbook.getWorksheet(options.sheetName || options.sheetId);\r\n\r\n      var csvStream = csv.createWriteStream(options);\r\n      stream.on('finish', () => { resolve(); });\r\n      csvStream.on('error', reject);\r\n      csvStream.pipe(stream);\r\n\r\n      var dateFormat = options.dateFormat;\r\n      var map = options.map || (value => {\r\n          if (value) {\r\n            if (value.text || value.hyperlink) {\r\n              return value.hyperlink || value.text || '';\r\n            }\r\n            if (value.formula || value.result) {\r\n              return value.result || '';\r\n            }\r\n            if (value instanceof Date) {\r\n              return dateFormat ? moment(value).format(dateFormat) : moment(value).format();\r\n            }\r\n            if (value.error) {\r\n              return value.error;\r\n            }\r\n            if (typeof value === 'object') {\r\n              return JSON.stringify(value);\r\n            }\r\n          }\r\n          return value;\r\n        });\r\n\r\n      var includeEmptyRows = (options.includeEmptyRows === undefined) || options.includeEmptyRows;\r\n      var lastRow = 1;\r\n      if (worksheet) {\r\n        worksheet.eachRow(function(row, rowNumber) {\r\n          if (includeEmptyRows) {\r\n            while (lastRow++ < rowNumber - 1) {\r\n              csvStream.write([]);\r\n            }\r\n          }\r\n          var values = row.values;\r\n          values.shift();\r\n          csvStream.write(values.map(map));\r\n          lastRow = rowNumber;\r\n        });\r\n      }\r\n      csvStream.end();\r\n    });\r\n  },\r\n  writeFile: function(filename, options) {\r\n    options = options || {};\r\n\r\n    var streamOptions = {\r\n      encoding: options.encoding || 'utf8'\r\n    };\r\n    var stream = fs.createWriteStream(filename, streamOptions);\r\n\r\n    return this.write(stream, options);\r\n  }\r\n};\r\n"]}