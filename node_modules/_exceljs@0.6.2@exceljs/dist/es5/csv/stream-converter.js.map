{"version":3,"sources":["../../../lib/csv/stream-converter.js"],"names":["jconv","StreamConverter","module","exports","inner","options","innerEncoding","toUpperCase","outerEncoding","innerBOM","outerBOM","writeStarted","prototype","convertInwards","data","Buffer","convert","convertOutwards","addListener","event","handler","removeListener","write","encoding","callback","Function","undefined","length","bomless","copy","read","pipe","destination","reverseConverter","close","on","type","chunk","once","end","emit","value"],"mappings":"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","file":"stream-converter.js","sourcesContent":["'use strict';\r\n\r\n// =======================================================================================================\r\n// StreamConverter\r\n//\r\n// convert between encoding schemes in a stream\r\n// Work in Progress - Will complete this at some point\r\nvar jconv;\r\n\r\nvar StreamConverter = module.exports = function(inner, options) {\r\n  this.inner = inner;\r\n\r\n  options = options || {};\r\n  this.innerEncoding = (options.innerEncoding || 'UTF8').toUpperCase();\r\n  this.outerEncoding = (options.outerEncoding || 'UTF8').toUpperCase();\r\n\r\n  this.innerBOM = options.innerBOM || null;\r\n  this.outerBOM = options.outerBOM || null;\r\n\r\n  this.writeStarted = false;\r\n};\r\n\r\nStreamConverter.prototype.convertInwards = function(data) {\r\n  if (data) {\r\n    if (typeof data === 'string') {\r\n      data = new Buffer(data, this.outerEncoding);\r\n    }\r\n\r\n    if (this.innerEncoding !== this.outerEncoding) {\r\n      data = jconv.convert(data, this.outerEncoding, this.innerEncoding);\r\n    }\r\n  }\r\n\r\n  return data;\r\n};\r\nStreamConverter.prototype.convertOutwards = function(data) {\r\n  if (typeof data === 'string') {\r\n    data = new Buffer(data, this.innerEncoding);\r\n  }\r\n\r\n  if (this.innerEncoding !== this.outerEncoding) {\r\n    data = jconv.convert(data, this.innerEncoding, this.outerEncoding);\r\n  }\r\n  return data;\r\n};\r\n\r\nStreamConverter.prototype.addListener = function(event, handler) {\r\n  this.inner.addListener(event, handler);\r\n};\r\n\r\nStreamConverter.prototype.removeListener = function(event, handler) {\r\n  this.inner.removeListener(event, handler);\r\n};\r\n\r\nStreamConverter.prototype.write = function(data, encoding, callback) {\r\n  if (encoding instanceof Function) {\r\n    callback = encoding;\r\n    encoding = undefined;\r\n  }\r\n\r\n  if (!this.writeStarted) {\r\n    // if inner encoding has BOM, write it now\r\n    if (this.innerBOM) {\r\n      this.inner.write(this.innerBOM);\r\n    }\r\n\r\n    // if outer encoding has BOM, delete it now\r\n    if (this.outerBOM) {\r\n      if (data.length <= this.outerBOM.length) {\r\n        if (callback) { callback(); }\r\n        return;\r\n      }\r\n      var bomless = new Buffer(data.length - this.outerBOM.length);\r\n      data.copy(bomless, 0, this.outerBOM.length, data.length);\r\n      data = bomless;\r\n    }\r\n\r\n    this.writeStarted = true;\r\n  }\r\n\r\n  this.inner.write(\r\n    this.convertInwards(data),\r\n    encoding ? this.innerEncoding : undefined,\r\n    callback);\r\n};\r\n\r\nStreamConverter.prototype.read = function() {\r\n  // TBD\r\n};\r\n\r\nStreamConverter.prototype.pipe = function(destination, options) {\r\n  var reverseConverter = new StreamConverter(destination, {\r\n    innerEncoding: this.outerEncoding,\r\n    outerEncoding: this.innerEncoding,\r\n    innerBOM: this.outerBOM,\r\n    outerBOM: this.innerBOM\r\n  });\r\n\r\n  this.inner.pipe(reverseConverter, options);\r\n};\r\n\r\nStreamConverter.prototype.close = function() {\r\n  this.inner.close();\r\n};\r\n\r\nStreamConverter.prototype.on = function(type, callback) {\r\n  switch (type) {\r\n    case 'data':\r\n      this.inner.on('data', chunk => {\r\n        callback(this.convertOutwards(chunk));\r\n      });\r\n      return this;\r\n    default:\r\n      this.inner.on(type, callback);\r\n      return this;\r\n  }\r\n};\r\n\r\nStreamConverter.prototype.once = function(type, callback) {\r\n  this.inner.once(type, callback);\r\n};\r\n\r\nStreamConverter.prototype.end = function(chunk, encoding, callback) {\r\n  this.inner.end(\r\n    this.convertInwards(chunk),\r\n    this.innerEncoding,\r\n    callback);\r\n};\r\n\r\nStreamConverter.prototype.emit = function(type, value) {\r\n  this.inner.emit(type, value);\r\n};\r\n"]}