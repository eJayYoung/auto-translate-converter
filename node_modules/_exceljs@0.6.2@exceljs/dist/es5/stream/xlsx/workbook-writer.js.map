{"version":3,"sources":["../../../../lib/stream/xlsx/workbook-writer.js"],"names":["fs","require","Archiver","PromishLib","StreamBuf","RelType","StylesXform","SharedStrings","DefinedNames","CoreXform","RelationshipsXform","ContentTypesXform","AppXform","WorkbookXform","SharedStringsXform","WorksheetWriter","theme1Xml","WorkbookWriter","module","exports","options","created","Date","modified","creator","lastModifiedBy","lastPrinted","useSharedStrings","sharedStrings","styles","useStyles","Mock","_definedNames","_worksheets","views","media","zip","stream","filename","createWriteStream","pipe","promise","Promish","all","addThemes","addOfficeRels","prototype","definedNames","_openStream","path","self","bufSize","batch","append","name","on","emit","_commitWorksheets","commitWorksheet","worksheet","committed","resolve","commit","promises","map","length","then","addContentTypes","addApp","addCore","addSharedStrings","addStyles","addWorkbookRels","addWorkbook","_finalize","nextId","i","addWorksheet","undefined","tabColor","console","trace","properties","Object","assign","id","workbook","pageSetup","autoFilter","getWorksheet","find","xml","xform","toXml","Id","Type","OfficeDocument","Target","CoreProperties","ExtenderProperties","model","worksheets","filter","Boolean","coreXform","count","sharedStringsXform","relationships","Styles","Theme","push","forEach","rId","Worksheet","prepare","reject","finalize"],"mappings":"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","file":"workbook-writer.js","sourcesContent":["/**\r\n * Copyright (c) 2015-2017 Guyon Roche\r\n * LICENCE: MIT - please refer to LICENCE file included with this module\r\n * or https://github.com/guyonroche/exceljs/blob/master/LICENSE\r\n */\r\n\r\n'use strict';\r\n\r\nvar fs = require('fs');\r\nvar Archiver = require('archiver');\r\nvar PromishLib = require('../../utils/promish');\r\n\r\nvar StreamBuf = require('../../utils/stream-buf');\r\n\r\nvar RelType = require('../../xlsx/rel-type');\r\nvar StylesXform = require('../../xlsx/xform/style/styles-xform');\r\nvar SharedStrings = require('../../utils/shared-strings');\r\nvar DefinedNames = require('../../doc/defined-names');\r\n\r\nvar CoreXform = require('../../xlsx/xform/core/core-xform');\r\nvar RelationshipsXform = require('../../xlsx/xform/core/relationships-xform');\r\nvar ContentTypesXform = require('../../xlsx/xform/core/content-types-xform');\r\nvar AppXform = require('../../xlsx/xform/core/app-xform');\r\nvar WorkbookXform = require('../../xlsx/xform/book/workbook-xform');\r\nvar SharedStringsXform = require('../../xlsx/xform/strings/shared-strings-xform');\r\n\r\nvar WorksheetWriter = require('./worksheet-writer');\r\n\r\nvar theme1Xml = require('../../xlsx/xml/theme1.js');\r\n\r\nvar WorkbookWriter = module.exports = function(options) {\r\n  options = options || {};\r\n\r\n  this.created = options.created || new Date();\r\n  this.modified = options.modified || this.created;\r\n  this.creator = options.creator || 'ExcelJS';\r\n  this.lastModifiedBy = options.lastModifiedBy || 'ExcelJS';\r\n  this.lastPrinted = options.lastPrinted;\r\n\r\n  // using shared strings creates a smaller xlsx file but may use more memory\r\n  this.useSharedStrings = options.useSharedStrings || false;\r\n  this.sharedStrings = new SharedStrings();\r\n\r\n  // style manager\r\n  this.styles = options.useStyles ? new StylesXform(true) : new StylesXform.Mock(true);\r\n\r\n  // defined names\r\n  this._definedNames = new DefinedNames();\r\n\r\n  this._worksheets = [];\r\n  this.views = [];\r\n\r\n  this.media = [];\r\n\r\n  this.zip = Archiver('zip');\r\n  if (options.stream) {\r\n    this.stream = options.stream;\r\n  } else if (options.filename) {\r\n    this.stream = fs.createWriteStream(options.filename);\r\n  } else {\r\n    this.stream = new StreamBuf();\r\n  }\r\n  this.zip.pipe(this.stream);\r\n\r\n  // these bits can be added right now\r\n  this.promise = PromishLib.Promish.all([\r\n    this.addThemes(),\r\n    this.addOfficeRels()\r\n  ]);\r\n};\r\n\r\nWorkbookWriter.prototype = {\r\n  get definedNames() {\r\n    return this._definedNames;\r\n  },\r\n\r\n  _openStream: function(path) {\r\n    var self = this;\r\n    var stream = new StreamBuf({bufSize: 65536, batch: true});\r\n    self.zip.append(stream, { name: path });\r\n    stream.on('finish', function() {\r\n      stream.emit('zipped');\r\n    });\r\n    return stream;\r\n  },\r\n  _commitWorksheets: function() {\r\n    var commitWorksheet = function(worksheet) {\r\n      if (!worksheet.committed) {\r\n        return new PromishLib.Promish(function(resolve) {\r\n          worksheet.stream.on('zipped', function() {\r\n            resolve();\r\n          });\r\n          worksheet.commit();\r\n        });\r\n      }\r\n      return PromishLib.Promish.resolve();\r\n    };\r\n    // if there are any uncommitted worksheets, commit them now and wait\r\n    var promises = this._worksheets.map(commitWorksheet);\r\n    if (promises.length) {\r\n      return PromishLib.Promish.all(promises);\r\n    }\r\n    return PromishLib.Promish.resolve();\r\n  },\r\n\r\n  commit: function() {\r\n    // commit all worksheets, then add suplimentary files\r\n    return this.promise.then(() => this._commitWorksheets())\r\n      .then(() => PromishLib.Promish.all([\r\n          this.addContentTypes(),\r\n          this.addApp(),\r\n          this.addCore(),\r\n          this.addSharedStrings(),\r\n          this.addStyles(),\r\n          this.addWorkbookRels()\r\n      ]))\r\n      .then(() => this.addWorkbook())\r\n      .then(() => this._finalize());\r\n  },\r\n  get nextId() {\r\n    // find the next unique spot to add worksheet\r\n    var i;\r\n    for (i = 1; i < this._worksheets.length; i++) {\r\n      if (!this._worksheets[i]) {\r\n        return i;\r\n      }\r\n    }\r\n    return this._worksheets.length || 1;\r\n  },\r\n  addWorksheet: function(name, options) {\r\n    // it's possible to add a worksheet with different than default\r\n    // shared string handling\r\n    // in fact, it's even possible to switch it mid-sheet\r\n    options = options || {};\r\n    var useSharedStrings = options.useSharedStrings !== undefined ?\r\n      options.useSharedStrings :\r\n      this.useSharedStrings;\r\n\r\n    if (options.tabColor) {\r\n      // eslint-disable-next-line no-console\r\n      console.trace('tabColor option has moved to { properties: tabColor: {...} }');\r\n      options.properties = Object.assign({\r\n        tabColor: options.tabColor\r\n      }, options.properties);\r\n    }\r\n\r\n    var id = this.nextId;\r\n    name = name || 'sheet' + id;\r\n\r\n    var worksheet = new WorksheetWriter({\r\n      id: id,\r\n      name: name,\r\n      workbook: this,\r\n      useSharedStrings: useSharedStrings,\r\n      properties: options.properties,\r\n      pageSetup: options.pageSetup,\r\n      views: options.views,\r\n      autoFilter: options.autoFilter\r\n    });\r\n\r\n    this._worksheets[id] = worksheet;\r\n    return worksheet;\r\n  },\r\n  getWorksheet: function(id) {\r\n    if (id === undefined) {\r\n      return this._worksheets.find(function() { return true; });\r\n    } else if (typeof id === 'number') {\r\n      return this._worksheets[id];\r\n    } else if (typeof id === 'string') {\r\n      return this._worksheets.find(function(worksheet) {\r\n        return worksheet && worksheet.name === id;\r\n      });\r\n    }\r\n    return undefined;\r\n  },\r\n  addStyles: function() {\r\n    var self = this;\r\n    return new PromishLib.Promish(function(resolve) {\r\n      self.zip.append(self.styles.xml, {name: 'xl/styles.xml'});\r\n      resolve();\r\n    });\r\n  },\r\n  addThemes: function() {\r\n    var self = this;\r\n    return new PromishLib.Promish(function(resolve) {\r\n      self.zip.append(theme1Xml, { name: 'xl/theme/theme1.xml' });\r\n      resolve();\r\n    });\r\n  },\r\n  addOfficeRels: function() {\r\n    var self = this;\r\n    return new PromishLib.Promish(function(resolve) {\r\n      var xform = new RelationshipsXform();\r\n      var xml = xform.toXml([\r\n        {Id: 'rId1', Type: RelType.OfficeDocument, Target: 'xl/workbook.xml'},\r\n        {Id: 'rId2', Type: RelType.CoreProperties, Target: 'docProps/core.xml'},\r\n        {Id: 'rId3', Type: RelType.ExtenderProperties, Target: 'docProps/app.xml'}\r\n      ]);\r\n      self.zip.append(xml, {name: '/_rels/.rels'});\r\n      resolve();\r\n    });\r\n  },\r\n\r\n  addContentTypes: function() {\r\n    return new PromishLib.Promish(resolve => {\r\n      var model = {\r\n        worksheets: this._worksheets.filter(Boolean)\r\n      };\r\n      var xform = new ContentTypesXform();\r\n      var xml = xform.toXml(model);\r\n      this.zip.append(xml, {name: '[Content_Types].xml'});\r\n      resolve();\r\n    });\r\n  },\r\n  addApp: function() {\r\n    return new PromishLib.Promish(resolve => {\r\n      var model = {\r\n        worksheets: this._worksheets.filter(Boolean)\r\n      };\r\n      var xform = new AppXform();\r\n      var xml = xform.toXml(model);\r\n      this.zip.append(xml, {name: 'docProps/app.xml'});\r\n      resolve();\r\n    });\r\n  },\r\n  addCore: function() {\r\n    var self = this;\r\n    return new PromishLib.Promish(function(resolve) {\r\n      var coreXform = new CoreXform();\r\n      var xml = coreXform.toXml(self);\r\n      self.zip.append(xml, {name: 'docProps/core.xml'});\r\n      resolve();\r\n    });\r\n  },\r\n  addSharedStrings: function() {\r\n    var self = this;\r\n    if (this.sharedStrings.count) {\r\n      return new PromishLib.Promish(function(resolve) {\r\n        var sharedStringsXform = new SharedStringsXform();\r\n        var xml = sharedStringsXform.toXml(self.sharedStrings);\r\n        self.zip.append(xml, {name: '/xl/sharedStrings.xml'});\r\n        resolve();\r\n      });\r\n    }\r\n    return PromishLib.Promish.resolve();\r\n  },\r\n  addWorkbookRels: function() {\r\n    var self = this;\r\n    var count = 1;\r\n    var relationships = [\r\n      {Id: 'rId' + (count++), Type: RelType.Styles, Target: 'styles.xml'},\r\n      {Id: 'rId' + (count++), Type: RelType.Theme, Target: 'theme/theme1.xml'}\r\n    ];\r\n    if (this.sharedStrings.count) {\r\n      relationships.push(\r\n        {Id: 'rId' + (count++), Type: RelType.SharedStrings, Target: 'sharedStrings.xml'}\r\n      );\r\n    }\r\n    this._worksheets.forEach(function(worksheet) {\r\n      if (worksheet) {\r\n        worksheet.rId = 'rId' + (count++);\r\n        relationships.push(\r\n          {Id: worksheet.rId, Type: RelType.Worksheet, Target: 'worksheets/sheet' + worksheet.id + '.xml'}\r\n        );\r\n      }\r\n    });\r\n    return new PromishLib.Promish(function(resolve) {\r\n      var xform = new RelationshipsXform();\r\n      var xml = xform.toXml(relationships);\r\n      self.zip.append(xml, {name: '/xl/_rels/workbook.xml.rels'});\r\n      resolve();\r\n    });\r\n  },\r\n  addWorkbook: function() {\r\n    var zip = this.zip;\r\n    var model = {\r\n      worksheets: this._worksheets.filter(Boolean),\r\n      definedNames: this._definedNames.model,\r\n      views: this.views,\r\n      properties: {}\r\n    };\r\n\r\n    return new PromishLib.Promish(function(resolve) {\r\n      var xform = new WorkbookXform();\r\n      xform.prepare(model);\r\n      zip.append(xform.toXml(model), {name: '/xl/workbook.xml'});\r\n      resolve();\r\n    });\r\n  },\r\n  _finalize: function() {\r\n    return new PromishLib.Promish((resolve, reject) => {\r\n      this.stream.on('error', reject);\r\n      this.stream.on('finish', () => {\r\n        resolve(this);\r\n      });\r\n      this.zip.on('error', reject);\r\n\r\n      this.zip.finalize();\r\n    });\r\n  }\r\n};\r\n"]}