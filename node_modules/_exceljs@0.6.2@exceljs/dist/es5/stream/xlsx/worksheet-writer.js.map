{"version":3,"sources":["../../../../lib/stream/xlsx/worksheet-writer.js"],"names":["_","require","RelType","colCache","Dimensions","StringBuf","Row","Column","SheetRelsWriter","DataValidations","xmlBuffer","ListXform","DataValidationsXform","SheetPropertiesXform","SheetFormatPropertiesXform","ColXform","RowXform","HyperlinkXform","SheetViewXform","PageMarginsXform","PageSetupXform","AutoFilterXform","PictureXform","xform","dataValidations","sheetProperties","sheetFormatProperties","columns","tag","length","childXform","row","hyperlinks","sheetViews","pageMargins","pageSeteup","autoFilter","picture","WorksheetWriter","module","exports","options","id","name","_rows","_columns","_keys","_merges","add","_sheetRelsWriter","_dimensions","_rowZero","committed","_formulae","_siFormulae","properties","Object","assign","defaultRowHeight","dyDescent","outlineLevelCol","outlineLevelRow","pageSetup","margins","left","right","top","bottom","header","footer","orientation","horizontalDpi","verticalDpi","fitToPage","fitToWidth","fitToHeight","scale","pageOrder","blackAndWhite","draft","cellComments","errors","paperSize","undefined","showRowColHeaders","showGridLines","horizontalCentered","verticalCentered","rowBreaks","colBreaks","useSharedStrings","_workbook","workbook","_views","views","_writeOpenWorksheet","background","type","imageName","addMedia","pictureId","Target","Type","Image","_background","rId","startedData","prototype","stream","_stream","_openStream","pause","destroy","Error","commit","forEach","cRow","_writeRow","_writeOpenSheetData","_writeCloseSheetData","_writeAutoFilter","_writeMergeCells","_writeHyperlinks","_writeDataValidations","_writePageMargins","_writePageSetup","_writeBackground","_writeCloseWorksheet","end","dimensions","value","_headerRowCount","reduce","pv","cv","headerCount","headers","Math","max","count","column","push","defn","getColumnKey","key","setColumnKey","deleteColumnKey","eachColumnKey","f","each","getColumn","c","col","l2n","n","_nextRow","eachRow","iteratee","includeEmpty","i","getRow","hasValues","number","_commitRow","found","shift","lastRow","findRow","rowNumber","index","addRow","values","findCell","r","address","getAddress","getCell","getCellEx","mergeCells","Array","slice","call","arguments","merge","intersects","master","j","_write","text","reset","addText","write","_writeSheetProperties","xmlBuf","sheetPropertiesModel","tabColor","toXml","_writeSheetFormatProperties","sheetFormatPropertiesModel","_writeColumns","cols","toModel","prepare","styles","height","model","sharedStrings","hyperlinksProxy","merges","formulae","siFormulae","_hyperlinks","_writeDimensions"],"mappings":"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","file":"worksheet-writer.js","sourcesContent":["/**\r\n * Copyright (c) 2015-2017 Guyon Roche\r\n * LICENCE: MIT - please refer to LICENCE file included with this module\r\n * or https://github.com/guyonroche/exceljs/blob/master/LICENSE\r\n */\r\n\r\n'use strict';\r\n\r\nvar _ = require('../../utils/under-dash');\r\n\r\nvar RelType = require('../../xlsx/rel-type');\r\n\r\nvar colCache = require('../../utils/col-cache');\r\nvar Dimensions = require('../../doc/range');\r\n\r\nvar StringBuf = require('../../utils/string-buf');\r\n\r\nvar Row = require('../../doc/row');\r\nvar Column = require('../../doc/column');\r\n\r\nvar SheetRelsWriter = require('./sheet-rels-writer');\r\nvar DataValidations = require('../../doc/data-validations');\r\n\r\nvar xmlBuffer = new StringBuf();\r\n\r\n// ============================================================================================\r\n// Xforms\r\nvar ListXform = require('../../xlsx/xform/list-xform');\r\nvar DataValidationsXform = require('../../xlsx/xform/sheet/data-validations-xform');\r\nvar SheetPropertiesXform = require('../../xlsx/xform/sheet/sheet-properties-xform');\r\nvar SheetFormatPropertiesXform = require('../../xlsx/xform/sheet/sheet-format-properties-xform');\r\nvar ColXform = require('../../xlsx/xform/sheet/col-xform');\r\nvar RowXform = require('../../xlsx/xform/sheet/row-xform');\r\nvar HyperlinkXform = require('../../xlsx/xform/sheet/hyperlink-xform');\r\nvar SheetViewXform = require('../../xlsx/xform/sheet/sheet-view-xform');\r\nvar PageMarginsXform = require('../../xlsx/xform/sheet/page-margins-xform');\r\nvar PageSetupXform = require('../../xlsx/xform/sheet/page-setup-xform');\r\nvar AutoFilterXform = require('../../xlsx/xform/sheet/auto-filter-xform');\r\nvar PictureXform = require('../../xlsx/xform/sheet/picture-xform');\r\n\r\n// since prepare and render is functional, we can use singletons\r\nvar xform = {\r\n  dataValidations: new DataValidationsXform(),\r\n  sheetProperties: new SheetPropertiesXform(),\r\n  sheetFormatProperties: new SheetFormatPropertiesXform(),\r\n  columns: new ListXform({tag: 'cols', length: false, childXform: new ColXform()}),\r\n  row: new RowXform(),\r\n  hyperlinks: new ListXform({tag: 'hyperlinks', length: false, childXform: new HyperlinkXform()}),\r\n  sheetViews: new ListXform({tag: 'sheetViews', length: false, childXform: new SheetViewXform()}),\r\n  pageMargins: new PageMarginsXform(),\r\n  pageSeteup: new PageSetupXform(),\r\n  autoFilter: new AutoFilterXform(),\r\n  picture: new PictureXform(),\r\n};\r\n\r\n\r\n// ============================================================================================\r\n\r\nvar WorksheetWriter = module.exports = function(options) {\r\n  // in a workbook, each sheet will have a number\r\n  this.id = options.id;\r\n\r\n  // and a name\r\n  this.name = options.name || 'Sheet' + this.id;\r\n\r\n  // rows are stored here while they need to be worked on.\r\n  // when they are committed, they will be deleted.\r\n  this._rows = [];\r\n\r\n  // column definitions\r\n  this._columns = null;\r\n\r\n  // column keys (addRow convenience): key ==> this._columns index\r\n  this._keys = {};\r\n\r\n  // keep record of all merges\r\n  this._merges = [];\r\n  this._merges.add = function() {}; // ignore cell instruction\r\n\r\n  // keep record of all hyperlinks\r\n  this._sheetRelsWriter = new SheetRelsWriter(options);\r\n\r\n  // keep a record of dimensions\r\n  this._dimensions = new Dimensions();\r\n\r\n  // first uncommitted row\r\n  this._rowZero = 1;\r\n\r\n  // committed flag\r\n  this.committed = false;\r\n\r\n  // for data validations\r\n  this.dataValidations = new DataValidations();\r\n\r\n  // for sharing formulae\r\n  this._formulae = {};\r\n  this._siFormulae = 0;\r\n\r\n  // for default row height, outline levels, etc\r\n  this.properties = Object.assign({}, {\r\n    defaultRowHeight: 15,\r\n    dyDescent: 55,\r\n    outlineLevelCol: 0,\r\n    outlineLevelRow: 0\r\n  }, options.properties);\r\n\r\n  // for all things printing\r\n  this.pageSetup = Object.assign({}, {\r\n    margins: {left: 0.7, right: 0.7, top: 0.75, bottom: 0.75, header: 0.3, footer: 0.3 },\r\n    orientation: 'portrait',\r\n    horizontalDpi: 4294967295,\r\n    verticalDpi: 4294967295,\r\n    fitToPage: !!(options.pageSetup && ((options.pageSetup.fitToWidth || options.pageSetup.fitToHeight) && !options.pageSetup.scale)),\r\n    pageOrder: 'downThenOver',\r\n    blackAndWhite: false,\r\n    draft: false,\r\n    cellComments: 'None',\r\n    errors: 'displayed',\r\n    scale: 100,\r\n    fitToWidth: 1,\r\n    fitToHeight: 1,\r\n    paperSize: undefined,\r\n    showRowColHeaders: false,\r\n    showGridLines: false,\r\n    horizontalCentered: false,\r\n    verticalCentered: false,\r\n    rowBreaks: null,\r\n    colBreaks: null\r\n  }, options.pageSetup);\r\n\r\n  // using shared strings creates a smaller xlsx file but may use more memory\r\n  this.useSharedStrings = options.useSharedStrings || false;\r\n\r\n  this._workbook = options.workbook;\r\n\r\n  // views\r\n  this._views = options.views || [];\r\n\r\n  // auto filter\r\n  this.autoFilter = options.autoFilter || null;\r\n\r\n  // start writing to stream now\r\n  this._writeOpenWorksheet();\r\n\r\n  // background\r\n  if (options.background && options.background.type === 'image') {\r\n    var imageName = this._workbook.addMedia(options.background);\r\n    var pictureId = this._sheetRelsWriter.addMedia({\r\n      Target: '../media/' + imageName,\r\n      Type: RelType.Image\r\n    });\r\n    this._background = {\r\n      rId: pictureId\r\n    };\r\n  }\r\n\r\n  this.startedData = false;\r\n};\r\n\r\nWorksheetWriter.prototype = {\r\n  get workbook() {\r\n    return this._workbook;\r\n  },\r\n\r\n  get stream() {\r\n    if (!this._stream) {\r\n      // eslint-disable-next-line no-underscore-dangle\r\n      this._stream = this._workbook._openStream('/xl/worksheets/sheet' + this.id + '.xml');\r\n\r\n      // pause stream to prevent 'data' events\r\n      this._stream.pause();\r\n    }\r\n    return this._stream;\r\n  },\r\n\r\n  // destroy - not a valid operation for a streaming writer\r\n  // even though some streamers might be able to, it's a bad idea.\r\n  destroy: function() {\r\n    throw new Error('Invalid Operation: destroy');\r\n  },\r\n\r\n  commit: function() {\r\n    if (this.committed) {\r\n      return;\r\n    }\r\n    // commit all rows\r\n    this._rows.forEach(cRow => {\r\n      if (cRow) {\r\n        // write the row to the stream\r\n        this._writeRow(cRow);\r\n      }\r\n    });\r\n\r\n    // we _cannot_ accept new rows from now on\r\n    this._rows = null;\r\n\r\n    if (!this.startedData) {\r\n        this._writeOpenSheetData();\r\n    }\r\n    this._writeCloseSheetData();\r\n    this._writeAutoFilter();\r\n    this._writeMergeCells();\r\n\r\n    // for some reason, Excel can't handle dimensions at the bottom of the file\r\n    // this._writeDimensions();\r\n\r\n    this._writeHyperlinks();\r\n    this._writeDataValidations();\r\n    this._writePageMargins();\r\n    this._writePageSetup();\r\n    this._writeBackground();\r\n    this._writeCloseWorksheet();\r\n\r\n    // signal end of stream to workbook\r\n    this.stream.end();\r\n\r\n    // also commit the hyperlinks if any\r\n    this._sheetRelsWriter.commit();\r\n\r\n    this.committed = true;\r\n  },\r\n\r\n  // return the current dimensions of the writer\r\n  get dimensions() {\r\n    return this._dimensions;\r\n  },\r\n\r\n  get views() {\r\n    return this._views;\r\n  },\r\n\r\n  // =========================================================================\r\n  // Columns\r\n\r\n  // get the current columns array.\r\n  get columns() {\r\n    return this._columns;\r\n  },\r\n\r\n  // set the columns from an array of column definitions.\r\n  // Note: any headers defined will overwrite existing values.\r\n  set columns(value) {\r\n    // calculate max header row count\r\n    this._headerRowCount = value.reduce((pv, cv) => {\r\n      var headerCount =\r\n        (cv.header && 1) ||\r\n        (cv.headers && cv.headers.length) ||\r\n        0;\r\n      return Math.max(pv, headerCount);\r\n    }, 0);\r\n\r\n    // construct Column objects\r\n    var count = 1;\r\n    var columns = this._columns = [];\r\n    value.forEach(defn => {\r\n      var column = new Column(this, count++, false);\r\n      columns.push(column);\r\n      column.defn = defn;\r\n    });\r\n  },\r\n\r\n  getColumnKey(key) {\r\n    return this._keys[key];\r\n  },\r\n  setColumnKey(key, value) {\r\n    this._keys[key] = value;\r\n  },\r\n  deleteColumnKey(key) {\r\n    delete this._keys[key];\r\n  },\r\n  eachColumnKey(f) {\r\n    _.each(this._keys, f);\r\n  },\r\n\r\n  // get a single column by col number. If it doesn't exist, it and any gaps before it\r\n  // are created.\r\n  getColumn: function(c) {\r\n    if (typeof c === 'string') {\r\n      // if it matches a key'd column, return that\r\n      var col = this._keys[c];\r\n      if (col) return col;\r\n\r\n      // otherwise, assume letter\r\n      c = colCache.l2n(c);\r\n    }\r\n    if (!this._columns) { this._columns = []; }\r\n    if (c > this._columns.length) {\r\n      var n = this._columns.length + 1;\r\n      while (n <= c) {\r\n        this._columns.push(new Column(this, n++));\r\n      }\r\n    }\r\n    return this._columns[c - 1];\r\n  },\r\n\r\n  // =========================================================================\r\n  // Rows\r\n  get _nextRow() {\r\n    return this._rowZero + this._rows.length;\r\n  },\r\n\r\n  // iterate over every uncommitted row in the worksheet, including maybe empty rows\r\n  eachRow: function(options, iteratee) {\r\n    if (!iteratee) {\r\n      iteratee = options;\r\n      options = undefined;\r\n    }\r\n    if (options && options.includeEmpty) {\r\n      var n = this._nextRow;\r\n      for (var i = this._rowZero; i < n; i++) {\r\n        iteratee(this.getRow(i), i);\r\n      }\r\n    } else {\r\n      this._rows.forEach(function(row) {\r\n        if (row.hasValues) {\r\n          iteratee(row, row.number);\r\n        }\r\n      });\r\n    }\r\n  },\r\n\r\n  _commitRow: function(cRow) {\r\n    // since rows must be written in order, we commit all rows up till and including cRow\r\n    var found = false;\r\n    while (this._rows.length && !found) {\r\n      var row = this._rows.shift();\r\n      this._rowZero++;\r\n      if (row) {\r\n        this._writeRow(row);\r\n        found = (row.number === cRow.number);\r\n        this._rowZero = row.number + 1;\r\n      }\r\n    }\r\n  },\r\n\r\n  get lastRow() {\r\n    // returns last uncommitted row\r\n    if (this._rows.length) {\r\n      return this._rows[this._rows.length - 1];\r\n    }\r\n    return undefined;\r\n  },\r\n\r\n  // find a row (if exists) by row number\r\n  findRow: function(rowNumber) {\r\n    var index = rowNumber - this._rowZero;\r\n    return this._rows[index];\r\n  },\r\n\r\n  getRow: function(rowNumber) {\r\n    var index = rowNumber - this._rowZero;\r\n\r\n    // may fail if rows have been comitted\r\n    if (index < 0) {\r\n      throw new Error('Out of bounds: this row has been committed');\r\n    }\r\n    var row = this._rows[index];\r\n    if (!row) {\r\n      this._rows[index] = row = new Row(this, rowNumber);\r\n    }\r\n    return row;\r\n  },\r\n\r\n  addRow: function(value) {\r\n    var row = new Row(this, this._nextRow);\r\n    this._rows[row.number - this._rowZero] = row;\r\n    row.values = value;\r\n    return row;\r\n  },\r\n\r\n  // ================================================================================\r\n  // Cells\r\n\r\n  // returns the cell at [r,c] or address given by r. If not found, return undefined\r\n  findCell: function(r, c) {\r\n    var address = colCache.getAddress(r, c);\r\n    var row = this.findRow(address.row);\r\n    return row ? row.findCell(address.column) : undefined;\r\n  },\r\n\r\n  // return the cell at [r,c] or address given by r. If not found, create a new one.\r\n  getCell: function(r, c) {\r\n    var address = colCache.getAddress(r, c);\r\n    var row = this.getRow(address.row);\r\n    return row.getCellEx(address);\r\n  },\r\n\r\n  mergeCells: function() {\r\n    // may fail if rows have been comitted\r\n    var dimensions = new Dimensions(Array.prototype.slice.call(arguments, 0)); // convert arguments into Array\r\n\r\n    // check cells aren't already merged\r\n    this._merges.forEach(function(merge) {\r\n      if (merge.intersects(dimensions)) {\r\n        throw new Error('Cannot merge already merged cells');\r\n      }\r\n    });\r\n\r\n    // apply merge\r\n    var master = this.getCell(dimensions.top, dimensions.left);\r\n    for (var i = dimensions.top; i <= dimensions.bottom; i++) {\r\n      for (var j = dimensions.left; j <= dimensions.right; j++) {\r\n        if ((i > dimensions.top) || (j > dimensions.left)) {\r\n          this.getCell(i, j).merge(master);\r\n        }\r\n      }\r\n    }\r\n\r\n    // index merge\r\n    this._merges.push(dimensions);\r\n  },\r\n\r\n  // ================================================================================\r\n  _write: function(text) {\r\n    xmlBuffer.reset();\r\n    xmlBuffer.addText(text);\r\n    this.stream.write(xmlBuffer);\r\n  },\r\n  _writeSheetProperties: function(xmlBuf, properties, pageSetup) {\r\n    var sheetPropertiesModel = {\r\n      tabColor: properties && properties.tabColor,\r\n      pageSetup: pageSetup && pageSetup.fitToPage ? {\r\n        fitToPage: pageSetup.fitToPage\r\n      } : undefined\r\n    };\r\n\r\n    xmlBuf.addText(xform.sheetProperties.toXml(sheetPropertiesModel));\r\n  },\r\n  _writeSheetFormatProperties: function(xmlBuf, properties) {\r\n    var sheetFormatPropertiesModel = properties ? {\r\n      defaultRowHeight: properties.defaultRowHeight,\r\n      dyDescent: properties.dyDescent,\r\n      outlineLevelCol: properties.outlineLevelCol,\r\n      outlineLevelRow: properties.outlineLevelRow\r\n    } : undefined;\r\n\r\n    xmlBuf.addText(xform.sheetFormatProperties.toXml(sheetFormatPropertiesModel));\r\n  },\r\n  _writeOpenWorksheet: function() {\r\n    xmlBuffer.reset();\r\n\r\n    xmlBuffer.addText('<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>');\r\n    xmlBuffer.addText(\r\n      '<worksheet xmlns=\"http://schemas.openxmlformats.org/spreadsheetml/2006/main\"' +\r\n      ' xmlns:r=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships\"' +\r\n      ' xmlns:mc=\"http://schemas.openxmlformats.org/markup-compatibility/2006\"' +\r\n      ' mc:Ignorable=\"x14ac\"' +\r\n      ' xmlns:x14ac=\"http://schemas.microsoft.com/office/spreadsheetml/2009/9/ac\">');\r\n\r\n    this._writeSheetProperties(xmlBuffer, this.properties, this.pageSetup);\r\n\r\n    xmlBuffer.addText(xform.sheetViews.toXml(this.views));\r\n\r\n    this._writeSheetFormatProperties(xmlBuffer, this.properties);\r\n\r\n    this.stream.write(xmlBuffer);\r\n  },\r\n  _writeColumns: function() {\r\n    var cols = Column.toModel(this.columns);\r\n    if (cols) {\r\n      xform.columns.prepare(cols, {styles: this._workbook.styles});\r\n      this.stream.write(xform.columns.toXml(cols));\r\n    }\r\n  },\r\n  _writeOpenSheetData: function() {\r\n    this._write('<sheetData>');\r\n  },\r\n  _writeRow: function(row) {\r\n    if (!this.startedData) {\r\n      this._writeColumns();\r\n      this._writeOpenSheetData();\r\n      this.startedData = true;\r\n    }\r\n\r\n    if (row.hasValues || row.height) {\r\n      var model = row.model;\r\n      var options = {\r\n        styles: this._workbook.styles,\r\n        sharedStrings: this.useSharedStrings ? this._workbook.sharedStrings : undefined,\r\n        hyperlinks: this._sheetRelsWriter.hyperlinksProxy,\r\n        merges: this._merges,\r\n        formulae: this._formulae,\r\n        siFormulae: this._siFormulae,\r\n      };\r\n      xform.row.prepare(model, options);\r\n      this.stream.write(xform.row.toXml(model));\r\n    }\r\n  },\r\n  _writeCloseSheetData: function() {\r\n    this._write('</sheetData>');\r\n  },\r\n  _writeMergeCells: function() {\r\n    if (this._merges.length) {\r\n      xmlBuffer.reset();\r\n      xmlBuffer.addText('<mergeCells count=\"' + this._merges.length + '\">');\r\n      this._merges.forEach(function(merge) {\r\n        xmlBuffer.addText('<mergeCell ref=\"' + merge + '\"/>');\r\n      });\r\n      xmlBuffer.addText('</mergeCells>');\r\n\r\n      this.stream.write(xmlBuffer);\r\n    }\r\n  },\r\n  _writeHyperlinks: function() {\r\n    // eslint-disable-next-line no-underscore-dangle\r\n    this.stream.write(xform.hyperlinks.toXml(this._sheetRelsWriter._hyperlinks));\r\n  },\r\n  _writeDataValidations: function() {\r\n    this.stream.write(xform.dataValidations.toXml(this.dataValidations.model));\r\n  },\r\n  _writePageMargins: function() {\r\n    this.stream.write(xform.pageMargins.toXml(this.pageSetup.margins));\r\n  },\r\n  _writePageSetup: function() {\r\n    this.stream.write(xform.pageSeteup.toXml(this.pageSetup));\r\n  },\r\n  _writeAutoFilter: function() {\r\n    this.stream.write(xform.autoFilter.toXml(this.autoFilter));\r\n  },\r\n  _writeBackground: function() {\r\n    if (this._background) {\r\n      this.stream.write(xform.picture.toXml(this._background));\r\n    }\r\n  },\r\n  _writeDimensions: function() {\r\n    // for some reason, Excel can't handle dimensions at the bottom of the file\r\n    // and we don't know the dimensions until the commit, so don't write them.\r\n    // this._write('<dimension ref=\"' + this._dimensions + '\"/>');\r\n  },\r\n  _writeCloseWorksheet: function() {\r\n    this._write('</worksheet>');\r\n  }\r\n};\r\n"]}