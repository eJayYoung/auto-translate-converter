{"version":3,"sources":["../../../lib/utils/flow-control.js"],"names":["events","require","PromishLib","utils","FlowControl","module","exports","options","queue","pipes","children","parent","flushing","gc","getTimeout","threshold","undefined","divisor","memory","process","memoryUsage","heapSize","heapTotal","Math","floor","inherits","EventEmitter","name","corked","join","length","some","child","stem","_write","dst","data","encoding","Promish","resolve","reject","write","error","_pipe","chunk","promises","forEach","pipe","sync","stream","push","end","all","then","callback","e","_animate","count","seq","cr","setInterval","stdout","_delay","timeout","anime","setTimeout","clearInterval","_flush","shift","setImmediate","emit","Function","nop","Error","stemFlow","unpipe","filter","createChild","Object","assign","on","item"],"mappings":"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","file":"flow-control.js","sourcesContent":["/**\r\n * Copyright (c) 2015-2017 Guyon Roche\r\n * LICENCE: MIT - please refer to LICENCE file included with this module\r\n * or https://github.com/guyonroche/exceljs/blob/master/LICENSE\r\n */\r\n\r\n'use strict';\r\n\r\nvar events = require('events');\r\nvar PromishLib = require('./promish');\r\n\r\nvar utils = require('./utils');\r\n\r\n// =============================================================================\r\n// FlowControl - Used to slow down streaming to manageable speed\r\n// Implements a subset of Stream.Duplex: pipe() and write()\r\nvar FlowControl = module.exports = function(options) {\r\n  this.options = options = options || {};\r\n\r\n  // Buffer queue\r\n  this.queue = [];\r\n\r\n  // Consumer streams\r\n  this.pipes = [];\r\n\r\n  // Down-stream flow-control instances\r\n  this.children = [];\r\n\r\n  // Up-stream flow-control instances\r\n  this.parent = options.parent;\r\n\r\n  // Ensure we don't flush more than once at a time\r\n  this.flushing = false;\r\n\r\n  // determine timeout for flow control delays\r\n  if (options.gc) {\r\n    var gc = options.gc;\r\n    if (gc.getTimeout) {\r\n      this.getTimeout = gc.getTimeout;\r\n    } else {\r\n      // heap size below which we don't bother delaying\r\n      var threshold = gc.threshold !== undefined ? gc.threshold : 150000000;\r\n      // convert from heapsize to ms timeout\r\n      var divisor = gc.divisor !== undefined ? gc.divisor : 500000;\r\n      this.getTimeout = function() {\r\n        var memory = process.memoryUsage();\r\n        var heapSize = memory.heapTotal;\r\n        return (heapSize < threshold) ? 0 : Math.floor(heapSize / divisor);\r\n      };\r\n    }\r\n  } else {\r\n    this.getTimeout = null;\r\n  }\r\n};\r\n\r\nutils.inherits(FlowControl, events.EventEmitter, {\r\n  get name() {\r\n    return [\r\n      'FlowControl',\r\n      this.parent ? 'Child' : 'Root',\r\n      this.corked ? 'corked' : 'open'\r\n    ].join(' ');\r\n  },\r\n  get corked() {\r\n    // We remain corked while we have children and at least one has data to consume\r\n    return (this.children.length > 0) &&\r\n      this.children.some(function(child) { return child.queue && child.queue.length; });\r\n  },\r\n  get stem() {\r\n    // the decision to stem the incoming data depends on whether the children are corked\r\n    // and how many buffers we have backed up\r\n    return this.corked || !this.queue || (this.queue.length > 2);\r\n  },\r\n\r\n  _write: function(dst, data, encoding) {\r\n    // Write to a single destination and return a promise\r\n\r\n    return new PromishLib.Promish(function(resolve, reject) {\r\n      dst.write(data, encoding, function(error) {\r\n        if (error) {\r\n          reject(error);\r\n        } else {\r\n          resolve();\r\n        }\r\n      });\r\n    });\r\n  },\r\n\r\n  _pipe: function(chunk) {\r\n    // Write chunk to all pipes. A chunk with no data is the end\r\n    var promises = [];\r\n    this.pipes.forEach(pipe => {\r\n      if (chunk.data) {\r\n        if (pipe.sync) {\r\n          pipe.stream.write(chunk.data, chunk.encoding);\r\n        } else {\r\n          promises.push(this._write(pipe.stream, chunk.data, chunk.encoding));\r\n        }\r\n      } else {\r\n        pipe.stream.end();\r\n      }\r\n    });\r\n    if (!promises.length) {\r\n      promises.push(PromishLib.Promish.resolve());\r\n    }\r\n    return PromishLib.Promish.all(promises)\r\n      .then(function() {\r\n        try {\r\n          chunk.callback();\r\n        } catch (e) {\r\n          // quietly ignore\r\n        }\r\n      });\r\n  },\r\n  _animate: function() {\r\n    var count = 0;\r\n    var seq = ['|', '/', '-', '\\\\'];\r\n    var cr = '\\u001b[0G'; // was '\\033[0G'\r\n    return setInterval(function() {\r\n      process.stdout.write(seq[count++ % 4] + cr);\r\n    }, 100);\r\n  },\r\n  _delay: function() {\r\n    // in certain situations it may be useful to delay processing (e.g. for GC)\r\n    var timeout = this.getTimeout && this.getTimeout();\r\n    if (timeout) {\r\n      return new PromishLib.Promish(resolve => {\r\n        var anime = this._animate();\r\n        setTimeout(() => {\r\n          clearInterval(anime);\r\n          resolve();\r\n        }, timeout);\r\n      });\r\n    }\r\n    return PromishLib.Promish.resolve();\r\n  },\r\n\r\n  _flush: function() {\r\n    // If/while not corked and we have buffers to send, send them\r\n    if (this.queue && !this.flushing && !this.corked) {\r\n      if (this.queue.length) {\r\n        this.flushing = true;\r\n        this._delay()\r\n          .then(() => this._pipe(this.queue.shift()))\r\n          .then(() => {\r\n            setImmediate(() => {\r\n              this.flushing = false;\r\n              this._flush();\r\n            });\r\n          });\r\n      }\r\n\r\n      if (!this.stem) {\r\n        // Signal up-stream that we're ready for more data\r\n        this.emit('drain');\r\n      }\r\n    }\r\n  },\r\n\r\n  write: function(data, encoding, callback) {\r\n    // Called by up-stream pipe\r\n    if (encoding instanceof Function) {\r\n      callback = encoding;\r\n      encoding = 'utf8';\r\n    }\r\n    callback = callback || utils.nop;\r\n\r\n    if (!this.queue) {\r\n      throw new Error('Cannot write to stream after end');\r\n    }\r\n\r\n    // Always queue chunks and then flush\r\n    this.queue.push({\r\n      data: data,\r\n      encoding: encoding,\r\n      callback: callback\r\n    });\r\n    this._flush();\r\n\r\n    // restrict further incoming data if we have backed up buffers or\r\n    // the children are still busy\r\n    var stemFlow = this.corked || (this.queue.length > 3);\r\n    return !stemFlow;\r\n  },\r\n\r\n  end: function() {\r\n    // Signal from up-stream\r\n    this.queue.push({\r\n      callback: () => {\r\n        this.queue = null;\r\n        this.emit('finish');\r\n      }\r\n    });\r\n    this._flush();\r\n  },\r\n\r\n  pipe: function(stream, options) {\r\n    options = options || {};\r\n\r\n    // some streams don't call callbacks\r\n    var sync = options.sync || false;\r\n\r\n    this.pipes.push({\r\n      stream: stream,\r\n      sync: sync\r\n    });\r\n  },\r\n  unpipe: function(stream) {\r\n    this.pipes = this.pipes.filter(function(pipe) {\r\n      return pipe.stream !== stream;\r\n    });\r\n  },\r\n\r\n  createChild: function() {\r\n    // Create a down-stream flow-control\r\n    var options = Object.assign({parent: this}, this.options);\r\n    var child = new FlowControl(options);\r\n    this.children.push(child);\r\n\r\n    child.on('drain', () => {\r\n      // a child is ready for more\r\n      this._flush();\r\n    });\r\n\r\n    child.on('finish', () => {\r\n      // One child has finished its stream. Remove it and continue\r\n      this.children = this.children.filter(item => item !== child);\r\n      this._flush();\r\n    });\r\n\r\n    return child;\r\n  }\r\n});\r\n"]}