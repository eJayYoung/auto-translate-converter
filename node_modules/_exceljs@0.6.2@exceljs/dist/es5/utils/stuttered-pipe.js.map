{"version":3,"sources":["../../../lib/utils/stuttered-pipe.js"],"names":["events","require","utils","StutteredPipe","module","exports","readable","writable","options","self","bufSize","autoPause","paused","eod","scheduled","on","end","resume","_schedule","inherits","EventEmitter","pause","clearImmediate","setImmediate","data","read","length","write"],"mappings":"AAAA;;;;;;AAMA;;AAEA,IAAIA,SAASC,QAAQ,QAAR,CAAb;;AAEA,IAAIC,QAAQD,QAAQ,SAAR,CAAZ;;AAEA;AACA;AACA,IAAIE,gBAAgBC,OAAOC,OAAP,GAAiB,UAASC,QAAT,EAAmBC,QAAnB,EAA6BC,OAA7B,EAAsC;AACzE,MAAIC,OAAO,IAAX;AACAD,YAAUA,WAAW,EAArB;;AAEA,OAAKF,QAAL,GAAgBA,QAAhB;AACA,OAAKC,QAAL,GAAgBA,QAAhB;AACA,OAAKG,OAAL,GAAeF,QAAQE,OAAR,IAAmB,KAAlC;AACA,OAAKC,SAAL,GAAiBH,QAAQG,SAAR,IAAqB,KAAtC;;AAEA,OAAKC,MAAL,GAAc,KAAd;AACA,OAAKC,GAAL,GAAW,KAAX;AACA,OAAKC,SAAL,GAAiB,IAAjB;;AAEAR,WAASS,EAAT,CAAY,KAAZ,EAAmB,YAAW;AAC5BN,SAAKI,GAAL,GAAW,IAAX;AACAN,aAASS,GAAT;AACD,GAHD;;AAKA;AACA;AACAV,WAASS,EAAT,CAAY,UAAZ,EAAwB,YAAW;AACjC,QAAI,CAACN,KAAKG,MAAV,EAAkB;AAChBH,WAAKQ,MAAL;AACD;AACF,GAJD;AAKA,OAAKC,SAAL;AACD,CA1BD;;AA4BAhB,MAAMiB,QAAN,CAAehB,aAAf,EAA8BH,OAAOoB,YAArC,EAAmD;AACjDC,SAAO,iBAAW;AAChB,SAAKT,MAAL,GAAc,IAAd;AACD,GAHgD;AAIjDK,UAAQ,kBAAW;AACjB,QAAI,CAAC,KAAKJ,GAAV,EAAe;AACb,UAAI,KAAKC,SAAL,KAAmB,IAAvB,EAA6B;AAC3BQ,uBAAe,KAAKR,SAApB;AACD;AACD,WAAKI,SAAL;AACD;AACF,GAXgD;AAYjDA,aAAW,qBAAW;AAAA;;AACpB,SAAKJ,SAAL,GAAiBS,aAAa,YAAM;AAClC,YAAKT,SAAL,GAAiB,IAAjB;AACA,UAAI,CAAC,MAAKD,GAAN,IAAa,CAAC,MAAKD,MAAvB,EAA+B;AAC7B,YAAIY,OAAO,MAAKlB,QAAL,CAAcmB,IAAd,CAAmB,MAAKf,OAAxB,CAAX;AACA,YAAIc,QAAQA,KAAKE,MAAjB,EAAyB;AACvB,gBAAKnB,QAAL,CAAcoB,KAAd,CAAoBH,IAApB;;AAEA,cAAI,CAAC,MAAKZ,MAAN,IAAgB,CAAC,MAAKD,SAA1B,EAAqC;AACnC,kBAAKO,SAAL;AACD;AACF,SAND,MAMO,IAAI,CAAC,MAAKN,MAAV,EAAkB;AACvB,gBAAKM,SAAL;AACD;AACF;AACF,KAdgB,CAAjB;AAeD;AA5BgD,CAAnD","file":"stuttered-pipe.js","sourcesContent":["/**\r\n * Copyright (c) 2015-2017 Guyon Roche\r\n * LICENCE: MIT - please refer to LICENCE file included with this module\r\n * or https://github.com/guyonroche/exceljs/blob/master/LICENSE\r\n */\r\n\r\n'use strict';\r\n\r\nvar events = require('events');\r\n\r\nvar utils = require('./utils');\r\n\r\n// =============================================================================\r\n// StutteredPipe - Used to slow down streaming so GC can get a look in\r\nvar StutteredPipe = module.exports = function(readable, writable, options) {\r\n  var self = this;\r\n  options = options || {};\r\n\r\n  this.readable = readable;\r\n  this.writable = writable;\r\n  this.bufSize = options.bufSize || 16384;\r\n  this.autoPause = options.autoPause || false;\r\n\r\n  this.paused = false;\r\n  this.eod = false;\r\n  this.scheduled = null;\r\n\r\n  readable.on('end', function() {\r\n    self.eod = true;\r\n    writable.end();\r\n  });\r\n\r\n  // need to have some way to communicate speed of stream\r\n  // back from the consumer\r\n  readable.on('readable', function() {\r\n    if (!self.paused) {\r\n      self.resume();\r\n    }\r\n  });\r\n  this._schedule();\r\n};\r\n\r\nutils.inherits(StutteredPipe, events.EventEmitter, {\r\n  pause: function() {\r\n    this.paused = true;\r\n  },\r\n  resume: function() {\r\n    if (!this.eod) {\r\n      if (this.scheduled !== null) {\r\n        clearImmediate(this.scheduled);\r\n      }\r\n      this._schedule();\r\n    }\r\n  },\r\n  _schedule: function() {\r\n    this.scheduled = setImmediate(() => {\r\n      this.scheduled = null;\r\n      if (!this.eod && !this.paused) {\r\n        var data = this.readable.read(this.bufSize);\r\n        if (data && data.length) {\r\n          this.writable.write(data);\r\n\r\n          if (!this.paused && !this.autoPause) {\r\n            this._schedule();\r\n          }\r\n        } else if (!this.paused) {\r\n          this._schedule();\r\n        }\r\n      }\r\n    });\r\n  }\r\n});\r\n"]}