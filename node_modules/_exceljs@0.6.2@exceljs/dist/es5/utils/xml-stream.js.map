{"version":3,"sources":["../../../lib/utils/xml-stream.js"],"names":["_","require","utils","OPEN_ANGLE","CLOSE_ANGLE","OPEN_ANGLE_SLASH","CLOSE_SLASH_ANGLE","EQUALS_QUOTE","QUOTE","SPACE","pushAttribute","xml","name","value","push","xmlEncode","toString","pushAttributes","attributes","each","undefined","XmlStream","module","exports","_xml","_stack","_rollbacks","StdDocAttributes","version","encoding","standalone","prototype","tos","length","openXml","docAttributes","openNode","parent","open","leaf","addAttribute","Error","addAttributes","attrs","writeText","text","writeXml","closeNode","node","pop","leafNode","closeAll","addRollback","stack","commit","rollback","r","splice","join"],"mappings":"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","file":"xml-stream.js","sourcesContent":["/**\r\n * Copyright (c) 2016-2017 Guyon Roche\r\n * LICENCE: MIT - please refer to LICENCE file included with this module\r\n * or https://github.com/guyonroche/exceljs/blob/master/LICENSE\r\n */\r\n\r\n'use strict';\r\n\r\nvar _ = require('./under-dash');\r\n\r\nvar utils = require('./utils');\r\n\r\n// constants\r\nvar OPEN_ANGLE = '<';\r\nvar CLOSE_ANGLE = '>';\r\nvar OPEN_ANGLE_SLASH = '</';\r\nvar CLOSE_SLASH_ANGLE = '/>';\r\nvar EQUALS_QUOTE = '=\"';\r\nvar QUOTE = '\"';\r\nvar SPACE = ' ';\r\n\r\nfunction pushAttribute(xml, name, value) {\r\n  xml.push(SPACE);\r\n  xml.push(name);\r\n  xml.push(EQUALS_QUOTE);\r\n  xml.push(utils.xmlEncode(value.toString()));\r\n  xml.push(QUOTE);\r\n}\r\nfunction pushAttributes(xml, attributes) {\r\n  if (attributes) {\r\n    _.each(attributes, function(value, name) {\r\n      if (value !== undefined) {\r\n        pushAttribute(xml, name, value);\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\nvar XmlStream = module.exports = function() {\r\n  this._xml = [];\r\n  this._stack = [];\r\n  this._rollbacks = [];\r\n};\r\n\r\nXmlStream.StdDocAttributes = {\r\n  version: '1.0',\r\n  encoding: 'UTF-8',\r\n  standalone: 'yes'\r\n};\r\n\r\nXmlStream.prototype = {\r\n  get tos() {\r\n    return this._stack.length ? this._stack[this._stack.length - 1] : undefined;\r\n  },\r\n  \r\n  openXml: function(docAttributes) {\r\n    var xml = this._xml;\r\n    // <?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\r\n    xml.push('<?xml');\r\n    pushAttributes(xml, docAttributes);\r\n    xml.push('?>\\n');\r\n  },\r\n  \r\n  openNode: function(name, attributes) {\r\n    var parent = this.tos;\r\n    var xml = this._xml;\r\n    if (parent && this.open) {\r\n      xml.push(CLOSE_ANGLE);\r\n    }\r\n\r\n    this._stack.push(name);\r\n\r\n    // start streaming node\r\n    xml.push(OPEN_ANGLE);\r\n    xml.push(name);\r\n    pushAttributes(xml, attributes);\r\n    this.leaf = true;\r\n    this.open = true;\r\n  },\r\n  addAttribute: function(name, value) {\r\n    if (!this.open) {\r\n      throw new Error('Cannot write attributes to node if it is not open');\r\n    }\r\n    pushAttribute(this._xml, name, value);\r\n  },\r\n  addAttributes: function(attrs) {\r\n    if (!this.open) {\r\n      throw new Error('Cannot write attributes to node if it is not open');\r\n    }\r\n    pushAttributes(this._xml, attrs);\r\n  },\r\n  writeText: function(text) {\r\n    var xml = this._xml;\r\n    if (this.open) {\r\n      xml.push(CLOSE_ANGLE);\r\n      this.open = false;\r\n    }\r\n    this.leaf = false;\r\n    xml.push(utils.xmlEncode(text.toString()));\r\n  },\r\n  writeXml: function(xml) {\r\n    if (this.open) {\r\n      this._xml.push(CLOSE_ANGLE);\r\n      this.open = false;\r\n    }\r\n    this.leaf = false;\r\n    this._xml.push(xml);\r\n  },\r\n  closeNode: function() {\r\n    var node = this._stack.pop();\r\n    var xml = this._xml;\r\n    if (this.leaf) {\r\n      xml.push(CLOSE_SLASH_ANGLE);\r\n    } else {\r\n      xml.push(OPEN_ANGLE_SLASH);\r\n      xml.push(node);\r\n      xml.push(CLOSE_ANGLE);\r\n    }\r\n    this.open = false;\r\n    this.leaf = false;\r\n  },\r\n  leafNode: function(name, attributes, text) {\r\n    this.openNode(name, attributes);\r\n    if (text !== undefined) { // zeros need to be written\r\n      this.writeText(text);\r\n    }\r\n    this.closeNode();\r\n  },\r\n\r\n  closeAll: function() {\r\n    while (this._stack.length) {\r\n      this.closeNode();\r\n    }\r\n  },\r\n\r\n  addRollback: function() {\r\n    this._rollbacks.push({\r\n      xml: this._xml.length,\r\n      stack: this._stack.length,\r\n      leaf: this.leaf,\r\n      open: this.open\r\n    });\r\n  },\r\n  commit: function() {\r\n    this._rollbacks.pop();\r\n  },\r\n  rollback: function() {\r\n    var r = this._rollbacks.pop();\r\n    if (this._xml.length > r.xml) {\r\n      this._xml.splice(r.xml, this._xml.length - r.xml);\r\n    }\r\n    if (this._stack.length > r.stack) {\r\n      this._stack.splice(r.stack, this._stack.length - r.stack);\r\n    }\r\n    this.leaf = r.leaf;\r\n    this.open = r.open;\r\n  },\r\n\r\n  get xml() {\r\n    this.closeAll();\r\n    return this._xml.join('');\r\n  }\r\n};\r\n"]}