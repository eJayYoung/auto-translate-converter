{"version":3,"sources":["../../../lib/xlsx/xlsx.js"],"names":["fs","require","ZipStream","StreamBuf","PromishLib","utils","XmlStream","StylesXform","CoreXform","SharedStringsXform","RelationshipsXform","ContentTypesXform","AppXform","WorkbookXform","WorksheetXform","DrawingXform","theme1Xml","XLSX","module","exports","workbook","fsReadFileAsync","filename","options","Promish","resolve","reject","readFile","error","data","RelType","prototype","self","stream","exists","then","Error","createReadStream","read","close","parseRels","xform","parseStream","parseWorkbook","parseSharedStrings","reconcile","model","workbookXform","worksheetXform","drawingXform","drawingOptions","media","mediaIndex","Object","keys","drawings","forEach","name","drawing","drawingRel","drawingRels","rels","reduce","o","rel","Id","sheetOptions","styles","sharedStrings","date1904","properties","worksheets","worksheet","relationships","worksheetRels","sheetNo","worksheetHash","globalRels","workbookRels","sheetDefs","processWorksheetEntry","entry","match","path","push","undefined","processWorksheetRelsEntry","processMediaEntry","lastDot","lastIndexOf","extension","substr","streamBuf","on","length","medium","type","buffer","toBuffer","pipe","processDrawingEntry","processDrawingRelsEntry","processThemeEntry","themes","toString","processIgnoreEntry","autodrain","createInputStream","promises","ZipReader","getEntryType","promise","entryPath","sheets","definedNames","views","appXform","appProperties","assign","company","manager","coreXform","coreProperties","all","emit","catch","zipStream","load","base64","Buffer","write","end","addMedia","zip","map","append","addDrawings","relsXform","prepare","xml","toXml","addContentTypes","addApp","addCore","addThemes","theme1","addOfficeRels","Type","OfficeDocument","Target","CoreProperties","ExtenderProperties","addWorkbookRels","count","Styles","Theme","SharedStrings","rId","Worksheet","id","addSharedStrings","addStyles","addWorkbook","addWorksheets","relationshipsXform","xmlStream","render","_finalize","finalize","prepareModel","creator","lastModifiedBy","created","Date","modified","useSharedStrings","useStyles","Mock","worksheetOptions","drawingsCount","ZipWriter","afters","writeFile","createWriteStream","writeBuffer"],"mappings":"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","file":"xlsx.js","sourcesContent":["/**\r\n * Copyright (c) 2014 Guyon Roche\r\n * LICENCE: MIT - please refer to LICENCE file included with this module\r\n * or https://github.com/guyonroche/exceljs/blob/master/LICENSE\r\n */\r\n\r\n'use strict';\r\n\r\nvar fs = require('fs');\r\nvar ZipStream = require('../utils/zip-stream');\r\nvar StreamBuf = require('../utils/stream-buf');\r\nvar PromishLib = require('../utils/promish');\r\n\r\nvar utils = require('../utils/utils');\r\nvar XmlStream = require('../utils/xml-stream');\r\n\r\nvar StylesXform = require('./xform/style/styles-xform');\r\n\r\nvar CoreXform = require('./xform/core/core-xform');\r\nvar SharedStringsXform = require('./xform/strings/shared-strings-xform');\r\nvar RelationshipsXform = require('./xform/core/relationships-xform');\r\nvar ContentTypesXform = require('./xform/core/content-types-xform');\r\nvar AppXform = require('./xform/core/app-xform');\r\nvar WorkbookXform = require('./xform/book/workbook-xform');\r\nvar WorksheetXform = require('./xform/sheet/worksheet-xform');\r\nvar DrawingXform = require('./xform/drawing/drawing-xform');\r\n\r\nvar theme1Xml = require('./xml/theme1.js');\r\n\r\nvar XLSX = module.exports = function(workbook) {\r\n  this.workbook = workbook;\r\n};\r\n\r\nfunction fsReadFileAsync(filename, options) {\r\n  return new PromishLib.Promish(function(resolve, reject) {\r\n    fs.readFile(filename, options, function(error, data) {\r\n      if (error) {\r\n        reject(error);\r\n      } else {\r\n        resolve(data);\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\nXLSX.RelType = require('./rel-type');\r\n\r\nXLSX.prototype = {\r\n  // ===============================================================================\r\n  // Workbook\r\n  // =========================================================================\r\n  // Read\r\n\r\n  readFile: function(filename) {\r\n    var self = this;\r\n    var stream;\r\n    return utils.fs.exists(filename)\r\n      .then(function(exists) {\r\n        if (!exists) {\r\n          throw new Error('File not found: ' + filename);\r\n        }\r\n        stream = fs.createReadStream(filename);\r\n        return self.read(stream);\r\n      })\r\n      .then(function(workbook) {\r\n        stream.close();\r\n        return workbook;\r\n      });\r\n  },\r\n  parseRels: function(stream) {\r\n    var xform = new RelationshipsXform();\r\n    return xform.parseStream(stream);\r\n  },\r\n  parseWorkbook: function(stream) {\r\n    var xform = new WorkbookXform();\r\n    return xform.parseStream(stream);\r\n  },\r\n  parseSharedStrings: function(stream) {\r\n    var xform = new SharedStringsXform();\r\n    return xform.parseStream(stream);\r\n  },\r\n  reconcile: function(model) {\r\n    var workbookXform = new WorkbookXform();\r\n    var worksheetXform = new WorksheetXform();\r\n    var drawingXform = new DrawingXform();\r\n\r\n    workbookXform.reconcile(model);\r\n\r\n    // reconcile drawings with their rels\r\n    var drawingOptions = {\r\n      media: model.media,\r\n      mediaIndex: model.mediaIndex,\r\n    };\r\n    Object.keys(model.drawings).forEach(function(name) {\r\n      var drawing = model.drawings[name];\r\n      var drawingRel = model.drawingRels[name];\r\n      if (drawingRel) {\r\n        drawingOptions.rels = drawingRel.reduce(\r\n          (o, rel) => { o[rel.Id] = rel; return o; },\r\n          {}\r\n        );\r\n        drawingXform.reconcile(drawing, drawingOptions);\r\n      }\r\n    });\r\n\r\n    var sheetOptions = {\r\n      styles: model.styles,\r\n      sharedStrings: model.sharedStrings,\r\n      media: model.media,\r\n      mediaIndex: model.mediaIndex,\r\n      date1904: model.properties.date1904,\r\n      drawings: model.drawings,\r\n    };\r\n    model.worksheets.forEach(function(worksheet) {\r\n      worksheet.relationships = model.worksheetRels[worksheet.sheetNo];\r\n      worksheetXform.reconcile(worksheet, sheetOptions);\r\n    });\r\n\r\n    // delete unnecessary parts\r\n    delete model.worksheetHash;\r\n    delete model.worksheetRels;\r\n    delete model.globalRels;\r\n    delete model.sharedStrings;\r\n    delete model.workbookRels;\r\n    delete model.sheetDefs;\r\n    delete model.styles;\r\n    delete model.mediaIndex;\r\n    delete model.drawings;\r\n    delete model.drawingRels;\r\n  },\r\n  processWorksheetEntry: function(entry, model) {\r\n    var match = entry.path.match(/xl\\/worksheets\\/sheet(\\d+)[.]xml/);\r\n    if (match) {\r\n      var sheetNo = match[1];\r\n      var xform = new WorksheetXform();\r\n      return xform.parseStream(entry)\r\n        .then(function(worksheet) {\r\n          worksheet.sheetNo = sheetNo;\r\n          model.worksheetHash[entry.path] = worksheet;\r\n          model.worksheets.push(worksheet);\r\n        });\r\n    }\r\n    return undefined;\r\n  },\r\n  processWorksheetRelsEntry: function(entry, model) {\r\n    var match = entry.path.match(/xl\\/worksheets\\/_rels\\/sheet(\\d+)[.]xml.rels/);\r\n    if (match) {\r\n      var sheetNo = match[1];\r\n      var xform = new RelationshipsXform();\r\n      return xform.parseStream(entry)\r\n        .then(function(relationships) {\r\n          model.worksheetRels[sheetNo] = relationships;\r\n        });\r\n    }\r\n    return undefined;\r\n  },\r\n  processMediaEntry: function(entry, model) {\r\n    var match = entry.path.match(/xl\\/media\\/([a-zA-Z0-9]+[.][a-zA-Z0-9]{3,4})$/);\r\n    if (match) {\r\n      var filename = match[1];\r\n      var lastDot = filename.lastIndexOf('.');\r\n      if (lastDot === -1) {\r\n        // if we can't determine extension, ignore it\r\n        return undefined;\r\n      }\r\n      var extension = filename.substr(lastDot + 1);\r\n      var name = filename.substr(0, lastDot);\r\n      return new PromishLib.Promish(function(resolve, reject) {\r\n        var streamBuf = new StreamBuf();\r\n        streamBuf.on('finish', function() {\r\n          model.mediaIndex[filename] = model.media.length;\r\n          model.mediaIndex[name] = model.media.length;\r\n          var medium = {\r\n            type: 'image',\r\n              name: name,\r\n            extension: extension,\r\n            buffer: streamBuf.toBuffer(),\r\n          };\r\n          model.media.push(medium);\r\n          resolve();\r\n        });\r\n        entry.on('error', function(error) {\r\n          reject(error);\r\n        });\r\n        entry.pipe(streamBuf);\r\n      });\r\n    }\r\n    return undefined;\r\n  },\r\n  processDrawingEntry: function(entry, model) {\r\n    var match = entry.path.match(/xl\\/drawings\\/([a-zA-Z0-9]+)[.]xml/);\r\n    if (match) {\r\n      var name = match[1];\r\n      var xform = new DrawingXform();\r\n      return xform.parseStream(entry)\r\n        .then(function(drawing) {\r\n          model.drawings[name] = drawing;\r\n        });\r\n    }\r\n    return undefined;\r\n  },\r\n  processDrawingRelsEntry: function(entry, model) {\r\n    var match = entry.path.match(/xl\\/drawings\\/_rels\\/([a-zA-Z0-9]+)[.]xml[.]rels/);\r\n    if (match) {\r\n      var name = match[1];\r\n      var xform = new RelationshipsXform();\r\n      return xform.parseStream(entry)\r\n        .then(function(relationships) {\r\n          model.drawingRels[name] = relationships;\r\n        });\r\n    }\r\n    return undefined;\r\n  },\r\n  processThemeEntry: function(entry, model) {\r\n    var match = entry.path.match(/xl\\/theme\\/([a-zA-Z0-9]+)[.]xml/);\r\n    if (match) {\r\n      return new PromishLib.Promish(function(resolve, reject) {\r\n        var name = match[1];\r\n        // TODO: stream entry into buffer and store the xml in the model.themes[]\r\n        var stream = new StreamBuf();\r\n        entry.on('error', reject);\r\n        stream.on('error', reject);\r\n        stream.on('finish', function() {\r\n          model.themes[name] = stream.read().toString();\r\n          resolve();\r\n        });\r\n        entry.pipe(stream);\r\n      });\r\n    }\r\n    return undefined;\r\n  },\r\n  processIgnoreEntry: function(entry) {\r\n    entry.autodrain();\r\n  },\r\n  createInputStream: function() {\r\n    var self = this;\r\n    var model = {\r\n      worksheets: [],\r\n      worksheetHash: {},\r\n      worksheetRels: [],\r\n      themes: {},\r\n      media: [],\r\n      mediaIndex: {},\r\n      drawings: {},\r\n      drawingRels: {},\r\n    };\r\n\r\n    // we have to be prepared to read the zip entries in whatever order they arrive\r\n    var promises = [];\r\n    var stream = new ZipStream.ZipReader({\r\n      getEntryType: path => (path.match(/xl\\/media\\//) ? 'nodebuffer' : 'string'),\r\n    });\r\n    stream.on('entry', function(entry) {\r\n      var promise = null;\r\n\r\n      var entryPath = entry.path;\r\n      if (entryPath[0] === '/') {\r\n        entryPath = entryPath.substr(1);\r\n      }\r\n      switch (entryPath) {\r\n        case '_rels/.rels':\r\n          promise = self.parseRels(entry)\r\n            .then(function(relationships) {\r\n              model.globalRels = relationships;\r\n            });\r\n          break;\r\n\r\n        case 'xl/workbook.xml':\r\n          promise = self.parseWorkbook(entry)\r\n            .then(function(workbook) {\r\n              model.sheets = workbook.sheets;\r\n              model.definedNames = workbook.definedNames;\r\n              model.views = workbook.views;\r\n              model.properties = workbook.properties;\r\n            });\r\n          break;\r\n\r\n        case 'xl/_rels/workbook.xml.rels':\r\n          promise = self.parseRels(entry)\r\n            .then(function(relationships) {\r\n              model.workbookRels = relationships;\r\n            });\r\n          break;\r\n\r\n        case 'xl/sharedStrings.xml':\r\n          model.sharedStrings = new SharedStringsXform();\r\n          promise = model.sharedStrings.parseStream(entry);\r\n          break;\r\n\r\n        case 'xl/styles.xml':\r\n          model.styles = new StylesXform();\r\n          promise = model.styles.parseStream(entry);\r\n          break;\r\n\r\n        case 'docProps/app.xml':\r\n          var appXform = new AppXform();\r\n          promise = appXform.parseStream(entry)\r\n            .then(function(appProperties) {\r\n              Object.assign(model, {\r\n                company: appProperties.company,\r\n                manager: appProperties.manager\r\n              });\r\n            });\r\n          break;\r\n\r\n        case 'docProps/core.xml':\r\n          var coreXform = new CoreXform();\r\n          promise = coreXform.parseStream(entry)\r\n            .then(function(coreProperties) {\r\n              Object.assign(model, coreProperties);\r\n            });\r\n          break;\r\n\r\n        default:\r\n          promise =\r\n            self.processWorksheetEntry(entry, model) ||\r\n            self.processWorksheetRelsEntry(entry, model) ||\r\n            self.processThemeEntry(entry, model) ||\r\n            self.processMediaEntry(entry, model) ||\r\n            self.processDrawingEntry(entry, model) ||\r\n            self.processDrawingRelsEntry(entry, model) ||\r\n            self.processIgnoreEntry(entry);\r\n          break;\r\n      }\r\n\r\n      if (promise) {\r\n        promises.push(promise);\r\n        promise = null;\r\n      }\r\n    });\r\n    stream.on('finished', function() {\r\n      PromishLib.Promish.all(promises)\r\n        .then(function() {\r\n          self.reconcile(model);\r\n\r\n          // apply model\r\n          self.workbook.model = model;\r\n        })\r\n        .then(function() {\r\n          stream.emit('done');\r\n        })\r\n        .catch(function(error) {\r\n          stream.emit('error', error);\r\n        });\r\n    });\r\n    return stream;\r\n  },\r\n\r\n  read: function(stream) {\r\n    var self = this;\r\n    var zipStream = this.createInputStream();\r\n    return new PromishLib.Promish(function(resolve, reject) {\r\n      zipStream.on('done', function() {\r\n        resolve(self.workbook);\r\n      }).on('error', function(error) {\r\n        reject(error);\r\n      });\r\n      stream.pipe(zipStream);\r\n    });\r\n  },\r\n\r\n  load: function(data, options) {\r\n    var self = this;\r\n    if (options === undefined) {\r\n      options = {};\r\n    }\r\n    var zipStream = this.createInputStream();\r\n    return new PromishLib.Promish(function(resolve, reject) {\r\n      zipStream.on('done', function() {\r\n        resolve(self.workbook);\r\n      }).on('error', function(error) {\r\n        reject(error);\r\n      });\r\n\r\n      if (options.base64) {\r\n        var buffer = new Buffer(data.toString(), 'base64');\r\n        zipStream.write(buffer);\r\n      } else {\r\n        zipStream.write(data);\r\n      }\r\n      zipStream.end();\r\n    });\r\n  },\r\n\r\n  // =========================================================================\r\n  // Write\r\n\r\n  addMedia: function(zip, model) {\r\n    return PromishLib.Promish.all(model.media.map(function(medium) {\r\n      if (medium.type === 'image') {\r\n        var filename = 'xl/media/' + medium.name + '.' + medium.extension;\r\n        if (medium.filename) {\r\n          return fsReadFileAsync(medium.filename)\r\n            .then(function(data) {\r\n              zip.append(data, {name: filename});\r\n            });\r\n        }\r\n        if (medium.buffer) {\r\n          return new PromishLib.Promish(function(resolve) {\r\n            zip.append(medium.buffer, {name: filename});\r\n            resolve();\r\n          });\r\n        }\r\n      }\r\n      return PromishLib.Promish.reject(new Error('Unsupported media'));\r\n    }));\r\n  },\r\n\r\n  addDrawings: function(zip, model) {\r\n    var drawingXform = new DrawingXform();\r\n    var relsXform = new RelationshipsXform();\r\n    var promises = [];\r\n\r\n    model.worksheets.forEach(function(worksheet) {\r\n      var drawing = worksheet.drawing;\r\n      if (drawing) {\r\n        promises.push(new PromishLib.Promish(function(resolve) {\r\n          drawingXform.prepare(drawing, {});\r\n          var xml = drawingXform.toXml(drawing);\r\n          zip.append(xml, {name: 'xl/drawings/' + drawing.name + '.xml'});\r\n\r\n          xml = relsXform.toXml(drawing.rels);\r\n          zip.append(xml, {name: 'xl/drawings/_rels/' + drawing.name + '.xml.rels'});\r\n\r\n          resolve();\r\n        }));\r\n      }\r\n    });\r\n\r\n    return PromishLib.Promish.all(promises);\r\n  },\r\n\r\n  addContentTypes: function(zip, model) {\r\n    return new PromishLib.Promish(function(resolve) {\r\n      var xform = new ContentTypesXform();\r\n      var xml = xform.toXml(model);\r\n      zip.append(xml, {name: '[Content_Types].xml'});\r\n      resolve();\r\n    });\r\n  },\r\n\r\n  addApp: function(zip, model) {\r\n    return new PromishLib.Promish(function(resolve) {\r\n      var xform = new AppXform();\r\n      var xml = xform.toXml(model);\r\n      zip.append(xml, {name: 'docProps/app.xml'});\r\n      resolve();\r\n    });\r\n  },\r\n\r\n  addCore: function(zip, model) {\r\n    return new PromishLib.Promish(function(resolve) {\r\n      var coreXform = new CoreXform();\r\n      zip.append(coreXform.toXml(model), {name: 'docProps/core.xml'});\r\n      resolve();\r\n    });\r\n  },\r\n\r\n  addThemes: function(zip, model) {\r\n    return new PromishLib.Promish(function(resolve) {\r\n      var themes = model.themes || { theme1: theme1Xml };\r\n      Object.keys(themes).forEach(function(name) {\r\n        var xml = themes[name];\r\n        var path = 'xl/theme/' + name + '.xml';\r\n        zip.append(xml, {name: path});\r\n      });\r\n      resolve();\r\n    });\r\n  },\r\n\r\n  addOfficeRels: function(zip) {\r\n    return new PromishLib.Promish(function(resolve) {\r\n      var xform = new RelationshipsXform();\r\n      var xml = xform.toXml([\r\n          {Id: 'rId1', Type: XLSX.RelType.OfficeDocument, Target: 'xl/workbook.xml'},\r\n          {Id: 'rId2', Type: XLSX.RelType.CoreProperties, Target: 'docProps/core.xml'},\r\n          {Id: 'rId3', Type: XLSX.RelType.ExtenderProperties, Target: 'docProps/app.xml'}\r\n        ]);\r\n      zip.append(xml, {name: '_rels/.rels'});\r\n      resolve();\r\n    });\r\n  },\r\n\r\n  addWorkbookRels: function(zip, model) {\r\n    var count = 1;\r\n    var relationships = [\r\n        {Id: 'rId' + (count++), Type: XLSX.RelType.Styles, Target: 'styles.xml'},\r\n        {Id: 'rId' + (count++), Type: XLSX.RelType.Theme, Target: 'theme/theme1.xml'}\r\n    ];\r\n    if (model.sharedStrings.count) {\r\n      relationships.push(\r\n        {Id: 'rId' + (count++), Type: XLSX.RelType.SharedStrings, Target: 'sharedStrings.xml'}\r\n      );\r\n    }\r\n    model.worksheets.forEach(function(worksheet) {\r\n      worksheet.rId = 'rId' + (count++);\r\n      relationships.push(\r\n        {Id: worksheet.rId, Type: XLSX.RelType.Worksheet, Target: 'worksheets/sheet' + worksheet.id + '.xml'}\r\n      );\r\n    });\r\n    return new PromishLib.Promish(function(resolve) {\r\n      var xform = new RelationshipsXform();\r\n      var xml = xform.toXml(relationships);\r\n      zip.append(xml, {name: 'xl/_rels/workbook.xml.rels'});\r\n      resolve();\r\n    });\r\n  },\r\n  addSharedStrings: function(zip, model) {\r\n    if (!model.sharedStrings || !model.sharedStrings.count) {\r\n      return PromishLib.Promish.resolve();\r\n    }\r\n    return new PromishLib.Promish(function(resolve) {\r\n      zip.append(model.sharedStrings.xml, {name: 'xl/sharedStrings.xml'});\r\n      resolve();\r\n    });\r\n  },\r\n  addStyles: function(zip, model) {\r\n    return new PromishLib.Promish(function(resolve) {\r\n      var xml = model.styles.xml;\r\n      if (xml) {\r\n        zip.append(xml, {name: 'xl/styles.xml'});\r\n      }\r\n      resolve();\r\n    });\r\n  },\r\n  addWorkbook: function(zip, model) {\r\n    return new PromishLib.Promish(function(resolve) {\r\n      var xform = new WorkbookXform();\r\n      zip.append(xform.toXml(model), {name: 'xl/workbook.xml'});\r\n      resolve();\r\n    });\r\n  },\r\n  addWorksheets: function(zip, model) {\r\n    return new PromishLib.Promish(function(resolve) {\r\n      // preparation phase\r\n      var worksheetXform = new WorksheetXform();\r\n      var relationshipsXform = new RelationshipsXform();\r\n\r\n      // write sheets\r\n      model.worksheets.forEach(function(worksheet) {\r\n        var xmlStream = new XmlStream();\r\n        worksheetXform.render(xmlStream, worksheet);\r\n        zip.append(xmlStream.xml, {name: 'xl/worksheets/sheet' + worksheet.id + '.xml'});\r\n\r\n        if (worksheet.rels && worksheet.rels.length) {\r\n          xmlStream = new XmlStream();\r\n          relationshipsXform.render(xmlStream, worksheet.rels);\r\n          zip.append(xmlStream.xml, {name: 'xl/worksheets/_rels/sheet' + worksheet.id + '.xml.rels'});\r\n        }\r\n      });\r\n\r\n      resolve();\r\n    });\r\n  },\r\n  _finalize: function(zip) {\r\n    return new PromishLib.Promish((resolve, reject) => {\r\n      zip.on('finish', () => {\r\n        resolve(this);\r\n      });\r\n      zip.on('error', reject);\r\n      zip.finalize();\r\n    });\r\n  },\r\n  prepareModel: function(model, options) {\r\n    // ensure following properties have sane values\r\n    model.creator = model.creator || 'ExcelJS';\r\n    model.lastModifiedBy = model.lastModifiedBy || 'ExcelJS';\r\n    model.created = model.created || new Date();\r\n    model.modified = model.modified || new Date();\r\n\r\n    model.useSharedStrings = options.useSharedStrings !== undefined ?\r\n      options.useSharedStrings :\r\n      true;\r\n    model.useStyles = options.useStyles !== undefined ?\r\n      options.useStyles :\r\n      true;\r\n\r\n    // Manage the shared strings\r\n    model.sharedStrings = new SharedStringsXform();\r\n\r\n    // add a style manager to handle cell formats, fonts, etc.\r\n    model.styles = model.useStyles ? new StylesXform(true) : new StylesXform.Mock();\r\n\r\n    // prepare all of the things before the render\r\n    var workbookXform = new WorkbookXform();\r\n    var worksheetXform = new WorksheetXform();\r\n\r\n    workbookXform.prepare(model);\r\n\r\n    var worksheetOptions = {\r\n      sharedStrings: model.sharedStrings,\r\n      styles: model.styles,\r\n      date1904: model.properties.date1904,\r\n      drawingsCount: 0,\r\n      media: model.media,\r\n    };\r\n    worksheetOptions.drawings = model.drawings = [];\r\n    model.worksheets.forEach(function(worksheet) {\r\n      worksheetXform.prepare(worksheet, worksheetOptions);\r\n    });\r\n\r\n    // TODO: workbook drawing list\r\n  },\r\n  write: function(stream, options) {\r\n    options = options || {};\r\n    var model = this.workbook.model;\r\n    var zip = new ZipStream.ZipWriter();\r\n    zip.pipe(stream);\r\n\r\n    this.prepareModel(model, options);\r\n\r\n    // render\r\n    return PromishLib.Promish.resolve()\r\n      .then(() => this.addContentTypes(zip, model))\r\n      .then(() => this.addOfficeRels(zip, model))\r\n      .then(() => this.addWorkbookRels(zip, model))\r\n      .then(() => this.addWorksheets(zip, model))\r\n      .then(() => this.addSharedStrings(zip, model)) // always after worksheets\r\n      .then(() => this.addDrawings(zip, model))\r\n      .then(() => {\r\n        var promises = [\r\n          this.addThemes(zip, model),\r\n          this.addStyles(zip, model),\r\n        ];\r\n        return PromishLib.Promish.all(promises);\r\n      })\r\n      .then(() => this.addMedia(zip, model))\r\n      .then(() => {\r\n        var afters = [\r\n          this.addApp(zip, model),\r\n          this.addCore(zip, model),\r\n        ];\r\n        return PromishLib.Promish.all(afters);\r\n      })\r\n      .then(() => this.addWorkbook(zip, model))\r\n      .then(() => this._finalize(zip));\r\n  },\r\n  writeFile: function(filename, options) {\r\n    var self = this;\r\n    var stream = fs.createWriteStream(filename);\r\n\r\n    return new PromishLib.Promish(function(resolve, reject) {\r\n      stream.on('finish', function() {\r\n        resolve();\r\n      });\r\n      stream.on('error', function(error) {\r\n        reject(error);\r\n      });\r\n\r\n      self.write(stream, options)\r\n        .then(function() {\r\n          stream.end();\r\n        })\r\n        .catch(function(error) {\r\n          reject(error);\r\n        });\r\n    });\r\n  },\r\n  writeBuffer: function(options) {\r\n    var self = this;\r\n    var stream = new StreamBuf();\r\n    return self.write(stream, options)\r\n      .then(function() {\r\n        return stream.read();\r\n      });\r\n  }\r\n};\r\n"]}